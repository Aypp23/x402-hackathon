Base Sepolia x402 Migration Plan (Arcana)
Date: 2026-02-10

Goal (per /Users/aomine/Desktop/x402/tracks.txt)
- Migrate agent-to-agent payments from Arc Testnet / Circle Gateway x402 to Base Sepolia / Coinbase x402.
- Ensure orchestrator (buyer) uses CDP Wallets to custody funds and sign x402 payment payloads.
- Demonstrate tool chaining with at least two paid steps (HTTP 402 -> pay -> retry, twice).
- Provide spend/receipt logging per tool call.

Current State (what exists today)
1) Seller-side (paid endpoints)
- File: /Users/aomine/Desktop/x402/backend/src/routes/x402-agent-routes.ts
- Uses @circlefin/x402-batching/server createGatewayMiddleware({ sellerAddress })
- Has a manual settlement helper that hardcodes Arc CAIP-2 network:
  - network: eip155:5042002
  - asset: 0x3600000000000000000000000000000000000000 (Arc native USDC)

2) Buyer-side (orchestrator pays tools)
- Files:
  - /Users/aomine/Desktop/x402/backend/src/services/x402-agent-payments.ts
  - /Users/aomine/Desktop/x402/backend/src/services/x402-gateway-client.ts
  - /Users/aomine/Desktop/x402/backend/src/services/x402-client.ts
- Uses @circlefin/x402-batching/client GatewayClient({ chain: 'arcTestnet', privateKey })
- Startup wires this in:
  - /Users/aomine/Desktop/x402/backend/src/index.ts (initX402Payments(PRIVATE_KEY))

3) Gemini orchestration calls are not “true paid tool calls”
- File: /Users/aomine/Desktop/x402/backend/src/services/gemini.ts
- It typically fetches data locally, then triggers a “payment” call afterward.
- For the x402 track, we want the real handshake: request -> 402 -> pay -> retry -> data.

Plan Overview (target architecture)
- Seller: Express routes protected with Coinbase x402 payment middleware configured for Base Sepolia (eip155:84532).
- Buyer: Orchestrator uses a CDP Server Wallet v2 (CDP SDK) to sign x402 payments.
- Sellers: Each agent/tool has its own CDP Server Wallet v2 address as its payTo recipient.
- Paid tool calls: Gemini tool handlers call the paid endpoints directly (so each call produces an actual 402 handshake and receipt).
- Logging: each paid call records endpoint, price, network, payTo, receipt/tx hash, and running spend total.

Implementation Steps

Step 1 — Add Coinbase x402 dependencies (backend)
- Backend package.json currently includes @circlefin/x402-batching.
- Add (expected) dependencies for Coinbase x402:
  - @x402/express
  - @x402/core
  - @x402/evm
  - @x402/evm/exact (if split package; depends on published layout)
  - @x402/fetch or @x402/axios (buyer-side)
  - @coinbase/cdp-sdk (CDP Wallets v2)

Step 2 — Replace seller middleware (backend)
- Target file: /Users/aomine/Desktop/x402/backend/src/routes/x402-agent-routes.ts
- Replace:
  - createGatewayMiddleware(...) usage
  - BatchFacilitatorClient + handleManualSettlement
- With:
  - paymentMiddleware from @x402/express
  - x402ResourceServer + HTTPFacilitatorClient from @x402/core/server
  - ExactEvmScheme from @x402/evm/exact/server
  - facilitator URL (testnet): https://www.x402.org/facilitator
- Route config per endpoint should specify:
  - scheme: exact
  - price: "$0.xx"
  - network: "eip155:84532"
  - payTo: seller agent address (existing env vars ORACLE_X402_ADDRESS, etc.)
- Confirm: routes still mount under /api/x402 in /Users/aomine/Desktop/x402/backend/src/index.ts

Step 3 — Implement buyer x402 client using CDP Wallet signer (backend)
- Replace the Circle GatewayClient buyer usage.
- Create a CDP Server Wallet account on Base Sepolia:
  - Use @coinbase/cdp-sdk; create or load a stable “orchestrator” account.
- Create x402 buyer client:
  - Use @x402/fetch or @x402/axios
  - Register the EVM exact scheme signer for Base Sepolia.
  - Signer comes from the CDP account (via viem-compatible account wrapper).
- Update code paths:
  - /Users/aomine/Desktop/x402/backend/src/services/x402-agent-payments.ts
  - /Users/aomine/Desktop/x402/backend/src/services/x402-gateway-client.ts
  - /Users/aomine/Desktop/x402/backend/src/index.ts (startup init)

Step 3b — Provision CDP Wallets for all seller agents (backend)
- Create a CDP Server Wallet v2 account for each seller agent/tool:
  - Oracle, Scout, News, Yield, Tokenomics, NFT, Perp (matching current /api/x402 routes).
- Store each seller’s CDP address as the route’s payTo address.
- Persist the mapping so it is stable across restarts/deploys:
  - Option A: environment variables for each agent address (simplest)
  - Option B: store in Supabase (recommended for deployment/repro)
- Note: seller wallets do not need to sign x402 payments to receive funds; x402 verification/settlement is handled by the seller middleware + facilitator.

Step 4 — Make Gemini tool calls “paid-first” (true x402 handshake)
- Target file: /Users/aomine/Desktop/x402/backend/src/services/gemini.ts
- For each paid capability:
  - Replace local data fetch + separate payment call with:
    1) fetch paid endpoint (expect 402)
    2) buyer pays + retries automatically (via x402 fetch wrapper)
    3) use returned data in the final response
- Result: “agentsUsed” and “x402Transactions” correspond to real x402 receipts.

Step 5 — Logging, spend summary, and receipts
- Track per paid call:
  - endpoint
  - price
  - network (eip155:84532)
  - payTo
  - payment receipt (settle response headers / tx hash)
  - timestamp
  - cumulative spend per session
- Persist using existing Supabase logging utilities (backend already has /services/supabase.ts).
- Add an endpoint to retrieve spend summary for the demo, e.g.:
  - GET /dashboard/spend?sessionId=...
  - or include spend summary in /query response payload.

Step 5b — Cost reasoning + trace (instrumentation for x402 track)
- Add a per-request “trace” record that captures:
  - traceId, sessionId, userPrompt (optional), createdAt
  - budget: { limitUsd, spentUsdStart, spentUsdEnd, remainingUsdEnd }
  - decision log entries per step:
    - stepIndex, toolName, endpoint, quotedPriceUsd, reason, budgetBeforeUsd, budgetAfterUsd
    - outcome: success|skipped|failed
    - receiptRef: txHash or facilitator receipt id (if available)
    - latencyMs
- Enforce “budget-aware pruning” in the orchestrator:
  - If remaining budget < next tool price, skip the tool and log a decision entry with outcome=skipped.
  - Prefer cheaper tools when multiple can satisfy a request (log the tradeoff reason).
- Return trace metadata in the main /query response:
  - traceId
  - totalSpendUsd
  - steps[] (decision log summary)

Step 5c — Dashboard/Providers UX hooks (minimal but judge-visible)
- Providers page:
  - show each agent’s price (already present) plus a simple “Pricing model” label (per-call fixed).
  - show “Paid tools” badge(s) for endpoints that are x402-protected.
- Dashboard:
  - show “Spend summary” for the active session/trace (spent vs budget, and count of paid calls).
  - show a “Receipts” list (tool, price, payTo, txHash/receiptRef).
  - show a “Decision log” (why each paid tool was chosen or skipped).
- UX defaults:
  - confirmations optional (auto-pay enabled by default for the demo), but always surface price before execution in the trace.
  - sane default budget (e.g., $1.00) with a simple override via query param or config for the demo.

Step 6 — Funding story for demo (Base Sepolia)
- Buyer/orchestrator (CDP wallet) needs Base Sepolia USDC (and likely some ETH for gas).
- Seller agents (CDP wallets) can receive USDC at their payTo addresses.
- Update the UI guidance if needed:
  - The frontend “Get test USDC” page already shows Base Sepolia USDC contract and balance:
    /Users/aomine/Desktop/x402/arc-agent-hub/src/pages/Deposit.tsx

Step 7 — De-risk by narrowing scope
- For the x402 track demo, prioritize 2–3 paid endpoints:
  - GET /api/x402/oracle/price?symbol=BTC (paid)
  - GET /api/x402/scout/gas (paid)
  - GET /api/x402/news/latest (paid)
- Ensure the demo shows:
  - a 402 response
  - auto payment + retry
  - receipts logged
  - total spend summarized

Verification Checklist (must pass for submission)
1) Seller endpoints on Base Sepolia
- Request an x402-protected route without payment:
  - should return HTTP 402
  - accepts should include: network eip155:84532

2) Buyer uses CDP Wallets
- Confirm orchestrator’s signer is derived from CDP wallet (not a raw EVM private key).
- Provide config proof (env vars + initialization logs) for demo.

3) Tool chaining with spend reasoning
- One prompt triggers at least two distinct paid calls in sequence.
- Log shows:
  - tool chosen, price, cumulative budget, and receipt per call.

4) Receipts/logs evidence
- Store and display settle receipts/tx hashes for each paid call.
- Provide a single spend summary output (per workflow/session).

Notes / Known follow-ups
- This repo currently has Arc-specific payment assumptions (Arc native USDC, Arc chain id 5042002) in:
  - /Users/aomine/Desktop/x402/arc-agent-hub/src/hooks/useChat.ts (user pays on Arc Testnet)
  - /Users/aomine/Desktop/x402/backend/src/config.ts (Arc chain config + Arc contracts)
- For the x402 track, these do not have to be migrated immediately if the judged flow is the agent-to-agent x402 chaining on Base Sepolia.
  If you want a single-chain story, migrate user payment flow later to Base Sepolia ERC-20 USDC.
